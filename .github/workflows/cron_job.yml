name: Playwright Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies
        run: npm install

      - name: Install missing dependencies for Playwright
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-1 \
            libgraphene-1.0-0 \
            libwoff2dec0 \
            libvpx9 \
            libevent-2.1-7 \
            libopus0 \
            libgstreamer1.0-0 \
            libgstreamer-plugins-base1.0-0 \
            libflite1 \
            libavif16 \
            libharfbuzz-icu0 \
            libsecret-1-0 \
            libhyphen0 \
            libmanette-0.2-0 \
            libgles2-mesa-dev \
            libx264-164

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium firefox

      - name: Run Playwright Tests
        id: PlaywrightPortfolioStatus
        continue-on-error: true
        run: |
          npx playwright test --reporter=junit || echo "Tests failed but continuing..."

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 5

      - name: Send Slack Notification
        if: always()
        env:
          WEBHOOK_URL: https://hooks.slack.com/services/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
        run: |
          RESULTS_XML="playwright-report/results.xml"
          if [[ ! -f "$RESULTS_XML" ]]; then
            echo "Skipping Slack notification: results.xml not found!"
            exit 0
          fi

          # Extract test results from XML
          PASSED=$(grep -o 'tests="[^"]*"' "$RESULTS_XML" | grep -o '[0-9]*' | head -n 1)
          FAILED=$(grep -o 'failures="[^"]*"' "$RESULTS_XML" | grep -o '[0-9]*' | head -n 1)
          TIME=$(grep -o 'time="[^"]*"' "$RESULTS_XML" | grep -o '[0-9.]*' | head -n 1)

          curl -X POST -H 'Content-type: application/json' --data "{
            \"text\": \"Playwright Test Results:\n✔️ Passed: $PASSED\n❌ Failed: $FAILED\n⏱ Time: ${TIME}s\"
          }" $WEBHOOK_URL
