name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: "0 13 * * *"  # Runs every day at 13:00 UTC

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: |
          npm ci
          npx playwright install

      - name: Install missing system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-4-1 libgraphene-1.0-0 libwoff2-1 \
            libvpx9 libevent-2.1-7 libopus0 libgstreamer1.0-0 libgstreamer-plugins-base1.0-0 \
            libflite1 libavif16 libharfbuzz-icu0 libsecret-1-0 libhyphen0 \
            libmanette-0.2-0 libgles2-mesa libx264-164 xmlstarlet

      - name: Install Playwright Dependencies
        run: |
          npx playwright install-deps
          npx playwright install chromium
          npx playwright install firefox

      - name: Run Playwright tests
        run: |
          mkdir -p playwright-report  # Ensure the folder exists
          npx playwright test --reporter=junit --output=playwright-report

      - name: Check Playwright Report Folder
        run: ls -la playwright-report/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 1
          overwrite: true

      - name: Read XML and Send Slack Notification
        if: ${{ always() }}
        env:
          WEBHOOK_URL: https://hooks.slack.com/services/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
        run: |
          RESULTS_XML="playwright-report/results.xml"
          if [[ ! -f "$RESULTS_XML" ]]; then
            echo "Error: results.xml not found!"
            exit 1
          fi

          total_tests=$(xmlstarlet sel -t -v "/testsuites/@tests" $RESULTS_XML)
          failed_tests=$(xmlstarlet sel -t -v "/testsuites/@failures" $RESULTS_XML)
          skipped_tests=$(xmlstarlet sel -t -v "/testsuites/@skipped" $RESULTS_XML)
          passed_tests=$((total_tests - (failed_tests + skipped_tests)))

          if [ $failed_tests -eq 0 ]; then
            STATUS="passed"
            ICON="✔️"
            COLOR="00FF00"
          else
            STATUS="failed"
            ICON="❌"
            COLOR="FF0000"
          fi

          payload='{
            "@type": "MessageCard",
            "@context": "http://schema.org/extensions",
            "summary": "Daily Run",
            "themeColor": "'"$COLOR"'",
            "sections": [
              {
                "activityTitle": "New Daily Run",
                "facts": [
                  { "name": "Repository", "value": "${{ github.repository }}" },
                  { "name": "Status", "value": "'"$ICON $STATUS"'" },
                  { "name": "Total Tests", "value": "'"$total_tests"'" },
                  { "name": "Passed Tests", "value": "'"$passed_tests"'" },
                  { "name": "Failed Tests", "value": "'"$failed_tests"'" },
                  { "name": "Skipped Tests", "value": "'"$skipped_tests"'" },
                  { "name": "Report Download Url", "value": "[Click to Download Report](${{ steps.upload_artifact.outputs.artifact-url }})" },
                  { "name": "Project Name", "value": "Playwright Portfolio by Sabar & Yousaf" }
                ],
                "markdown": true
              }
            ]
          }'

          curl -X POST -H 'Content-type: application/json' --data "$payload" "$WEBHOOK_URL"
